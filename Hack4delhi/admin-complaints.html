<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Manage Complaints - Delhi Water-Logging System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar" id="main-navbar">
        <!-- Navigation will be dynamically loaded based on role -->
    </nav>

    <!-- Page Header -->
    <section class="dashboard-header">
        <div class="container">
            <h1>üîß Authority Complaint Management</h1>
            <p>Review, update, and manage citizen complaints</p>
            <div class="last-updated">Last Updated: <span id="current-time"></span></div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="summary-section">
        <div class="container">
            <div class="summary-grid">
                <div class="summary-card warning">
                    <h3>Pending Verification</h3>
                    <div class="summary-number" id="pending-count">0</div>
                </div>
                <div class="summary-card info">
                    <h3>Verified</h3>
                    <div class="summary-number" id="verified-count">0</div>
                </div>
                <div class="summary-card info">
                    <h3>In Progress</h3>
                    <div class="summary-number" id="progress-count">0</div>
                </div>
                <div class="summary-card stable">
                    <h3>Resolved</h3>
                    <div class="summary-number" id="resolved-count">0</div>
                </div>
                <div class="summary-card critical">
                    <h3>Escalated</h3>
                    <div class="summary-number" id="escalated-count">0</div>
                </div>
                <div class="summary-card">
                    <h3>Total Complaints</h3>
                    <div class="summary-number" id="total-count">0</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Filters & Search -->
    <section class="section" style="padding-top: 0;">
        <div class="container">
            <div class="search-filters">
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input" 
                    placeholder="üîç Search by ID, citizen name, phone, or address..."
                    oninput="filterComplaints()"
                >
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Status Filter</label>
                        <select id="status-filter" class="form-select" onchange="filterComplaints()">
                            <option value="">All Statuses</option>
                            <option value="Pending Verification">Pending Verification</option>
                            <option value="Verified">Verified</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Resolved">Resolved</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Appeal Raised">Appeal Raised</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Severity Filter</label>
                        <select id="severity-filter" class="form-select" onchange="filterComplaints()">
                            <option value="">All Severities</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Category Filter</label>
                        <select id="category-filter" class="form-select" onchange="filterComplaints()">
                            <option value="">All Categories</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Escalated Only</label>
                        <select id="escalated-filter" class="form-select" onchange="filterComplaints()">
                            <option value="">All</option>
                            <option value="true">Escalated Only</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container" style="margin-top: 2rem;">
                <table class="wards-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ward</th>
                            <th>Category</th>
                            <th>Severity</th>
                            <th>Created</th>
                            <th>Status</th>
                            <th>Escalated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="complaints-table-body">
                        <!-- Loaded dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="empty-state hidden">
                <div class="empty-icon">üì≠</div>
                <h3 class="empty-title">No Complaints Found</h3>
                <p class="empty-message">No complaints match your filter criteria</p>
            </div>
        </div>
    </section>

    <!-- Detail & Action Modal -->
    <div id="detail-modal" class="modal-overlay">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Complaint Management</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-content">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <!-- Actions loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Rejection Reason Modal -->
    <div id="rejection-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">‚ö†Ô∏è Rejection Confirmation</h3>
                <button class="modal-close" onclick="closeRejectionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" style="margin-bottom: 1.5rem;">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div class="alert-content">
                        <div class="alert-message">Rejecting a complaint requires a valid reason and detailed comment to ensure accountability.</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Rejection Reason <span style="color: #dc2626;">*</span></label>
                    <select id="rejection-reason" class="form-select">
                        <option value="">-- Select Reason --</option>
                        <option value="Duplicate">Duplicate</option>
                        <option value="Insufficient Evidence">Insufficient Evidence</option>
                        <option value="Not in Jurisdiction">Not in Jurisdiction</option>
                        <option value="Invalid Complaint">Invalid Complaint</option>
                        <option value="Already Resolved">Already Resolved</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div id="other-reason-container" class="form-group" style="display: none;">
                    <label class="form-label">Specify Reason <span style="color: #dc2626;">*</span></label>
                    <input type="text" id="other-reason-text" class="form-input" placeholder="Enter specific reason">
                </div>

                <div class="form-group">
                    <label class="form-label">Detailed Comment <span style="color: #dc2626;">*</span> (Minimum 30 characters)</label>
                    <textarea id="rejection-comment" class="form-textarea" rows="4" placeholder="Provide detailed explanation for rejection..."></textarea>
                    <small id="char-count" style="color: var(--text-tertiary); font-size: 0.875rem;">0 / 30 characters</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRejectionModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmRejection()" id="confirm-reject-btn" disabled>
                    Confirm Rejection
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2026 Delhi Water-Logging Monitoring System</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="data.js"></script>
    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script src="complaints.js"></script>
    <script>
        let allComplaints = [];
        let filteredComplaints = [];
        let currentComplaint = null;

        document.addEventListener('DOMContentLoaded', function() {
            initializeRoleBasedNavigation('admin-complaints');
            initializeTheme();
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000);
            
            populateFilters();
            loadComplaints();
        });

        function populateFilters() {
            const categoryFilter = document.getElementById('category-filter');
            COMPLAINT_CATEGORIES.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
        }

        function loadComplaints() {
            // DEBUGGING OUTPUT
            console.log("ADMIN MANAGE READ KEY delhiComplaints =", localStorage.getItem("delhiComplaints"));
            
            // Load complaints from the single source of truth
            const rawComplaints = getComplaints();
            
            console.log("ADMIN MANAGE complaints count =", rawComplaints.length);
            console.log("Sample complaint data:", rawComplaints[0]);
            
            // Normalize all complaints with safe defaults to prevent filtering issues
            allComplaints = rawComplaints.map(c => ({
                ...c,
                status: c.status || "Pending Verification",
                severity: c.severity || "Medium",
                escalated: !!c.escalated,
                timeline: c.timeline || [],
                officerComment: c.officerComment || "",
                eta: c.eta || "",
                department: c.department || "",
                category: c.category || "Water Logging",
                ward: c.ward || "Unknown",
                zone: c.zone || "Unknown"
            }));
            
            console.log("Normalized complaints:", allComplaints.length);
            
            filteredComplaints = allComplaints;
            
            updateStats();
            displayComplaints();
        }

        function updateStats() {
            const stats = getComplaintStats();
            
            document.getElementById('pending-count').textContent = stats.pending;
            document.getElementById('verified-count').textContent = stats.verified;
            document.getElementById('progress-count').textContent = stats.inProgress;
            document.getElementById('resolved-count').textContent = stats.resolved;
            document.getElementById('escalated-count').textContent = stats.escalated;
            document.getElementById('total-count').textContent = stats.total;
        }

        function filterComplaints() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const severityFilter = document.getElementById('severity-filter').value;
            const categoryFilter = document.getElementById('category-filter').value;
            const escalatedFilter = document.getElementById('escalated-filter').value;
            
            filteredComplaints = allComplaints.filter(c => {
                // Safe filtering with null checks
                const matchesSearch = !searchTerm || (
                    (c.id || "").toLowerCase().includes(searchTerm) ||
                    (c.citizen?.name || "").toLowerCase().includes(searchTerm) ||
                    (c.citizen?.phone || "").includes(searchTerm) ||
                    (c.address || "").toLowerCase().includes(searchTerm) ||
                    (c.ward || "").toLowerCase().includes(searchTerm)
                );
                
                const matchesStatus = !statusFilter || (c.status || "Pending Verification") === statusFilter;
                const matchesSeverity = !severityFilter || (c.severity || "Medium") === severityFilter;
                const matchesCategory = !categoryFilter || (c.category || "") === categoryFilter;
                const matchesEscalated = !escalatedFilter || (c.escalated || false) === (escalatedFilter === 'true');
                
                return matchesSearch && matchesStatus && matchesSeverity && matchesCategory && matchesEscalated;
            });
            
            console.log("Filtered complaints count:", filteredComplaints.length);
            displayComplaints();
        }

        function displayComplaints() {
            const tbody = document.getElementById('complaints-table-body');
            const emptyState = document.getElementById('empty-state');
            
            console.log("Displaying complaints:", filteredComplaints.length);
            
            if (filteredComplaints.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                
                // Update empty state message
                const emptyMessage = emptyState.querySelector('.empty-message');
                if (emptyMessage) {
                    if (allComplaints.length === 0) {
                        emptyMessage.textContent = 'No complaints registered yet';
                    } else {
                        emptyMessage.textContent = 'No complaints match your filter criteria';
                    }
                }
                return;
            }
            
            emptyState.classList.add('hidden');
            
            // Sort by priority: Escalated > High Severity > Recent
            // Safe sorting with null checks
            const sorted = [...filteredComplaints].sort((a, b) => {
                // Escalated first
                const aEscalated = !!a.escalated;
                const bEscalated = !!b.escalated;
                if (aEscalated !== bEscalated) return bEscalated ? 1 : -1;
                
                // Then by severity
                const severityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                const aSeverity = severityOrder[a.severity] || 2;
                const bSeverity = severityOrder[b.severity] || 2;
                if (aSeverity !== bSeverity) {
                    return bSeverity - aSeverity;
                }
                
                // Then by date (newest first)
                const aDate = new Date(a.createdAt || 0);
                const bDate = new Date(b.createdAt || 0);
                return bDate - aDate;
            });
            
            tbody.innerHTML = sorted.map(c => `
                <tr style="${c.escalated ? 'background-color: rgba(220, 38, 38, 0.05);' : ''}">
                    <td><strong>${c.id}</strong></td>
                    <td>${c.ward}<br><small>${c.zone}</small></td>
                    <td>${c.category}</td>
                    <td><span class="badge badge-${c.severity.toLowerCase()}">${c.severity}</span></td>
                    <td>${formatDateShort(c.createdAt)}</td>
                    <td><span class="badge badge-${c.status.toLowerCase().replace(/\s+/g, '-')}">${c.status}</span></td>
                    <td>${c.escalated ? '<span class="badge badge-danger">Yes</span>' : '-'}</td>
                    <td>
                        <button class="btn btn-primary" style="font-size: 0.75rem; padding: 0.25rem 0.75rem;" onclick='viewComplaint(${JSON.stringify(c.id)})'>
                            Manage
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function viewComplaint(complaintId) {
            currentComplaint = getComplaint(complaintId);
            if (!currentComplaint) return;
            
            const modalContent = document.getElementById('modal-content');
            const modalFooter = document.getElementById('modal-footer');
            
            modalContent.innerHTML = `
                <!-- Citizen & Location Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <h4 style="margin-bottom: 1rem;">üë§ Citizen Information</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <div><strong>Name:</strong> ${currentComplaint.citizen.name}</div>
                            <div><strong>Phone:</strong> ${currentComplaint.citizen.phone}</div>
                            ${currentComplaint.citizen.email ? `<div><strong>Email:</strong> ${currentComplaint.citizen.email}</div>` : ''}
                        </div>
                    </div>

                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <h4 style="margin-bottom: 1rem;">üìç Location Details</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <div><strong>Ward:</strong> ${currentComplaint.ward}</div>
                            <div><strong>Zone:</strong> ${currentComplaint.zone}</div>
                            ${currentComplaint.lat && currentComplaint.lng ? `
                                <div>
                                    <a href="https://www.google.com/maps?q=${currentComplaint.lat},${currentComplaint.lng}" target="_blank" class="btn btn-secondary" style="font-size: 0.875rem; padding: 0.25rem 0.75rem;">
                                        üìç Open in Maps
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <!-- Status & Metadata -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Category</div>
                        <strong>${currentComplaint.category}</strong>
                    </div>
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Severity</div>
                        <span class="badge badge-${currentComplaint.severity.toLowerCase()}">${currentComplaint.severity}</span>
                    </div>
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Status</div>
                        <span class="badge badge-${currentComplaint.status.toLowerCase().replace(/\s+/g, '-')}">${currentComplaint.status}</span>
                    </div>
                    <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Escalated</div>
                        ${currentComplaint.escalated ? '<span class="badge badge-danger">Yes</span>' : '<span>No</span>'}
                    </div>
                    ${currentComplaint.department ? `
                        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Department</div>
                            <strong>${currentComplaint.department}</strong>
                        </div>
                    ` : ''}
                </div>

                <!-- Address & Description -->
                <div style="margin-bottom: 2rem;">
                    <div style="margin-bottom: 1rem;">
                        <strong>Address:</strong>
                        <p style="margin-top: 0.5rem; color: var(--text-secondary);">${currentComplaint.address}</p>
                    </div>
                    <div>
                        <strong>Problem Description:</strong>
                        <p style="margin-top: 0.5rem; color: var(--text-secondary);">${currentComplaint.description}</p>
                    </div>
                </div>

                <!-- Photo -->
                ${currentComplaint.photoBase64 ? `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;">üì∑ Photo Evidence</h4>
                        <img src="${currentComplaint.photoBase64}" alt="Complaint photo" style="max-width: 100%; border-radius: var(--radius-md); box-shadow: var(--shadow-md);">
                    </div>
                ` : ''}

                <!-- Timeline -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem;">üìÖ Status Timeline</h4>
                    <div class="timeline">
                        ${currentComplaint.timeline.map(t => `
                            <div class="timeline-item">
                                <div class="timeline-marker ${t.status}">
                                    ${t.status === 'completed' ? '‚úì' : t.status === 'current' ? '‚óè' : '‚óã'}
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-title">${t.step}</div>
                                    ${t.date ? `<div class="timeline-date">${formatDate(t.date)}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Audit Log -->
                ${currentComplaint.auditLog && currentComplaint.auditLog.length > 0 ? `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1rem;">üìã Audit Log / Action History</h4>
                        <div style="background: var(--bg-secondary); border-radius: var(--radius-md); padding: 1rem;">
                            ${currentComplaint.auditLog.map(log => `
                                <div style="padding: 0.75rem; margin-bottom: 0.5rem; background: var(--bg-primary); border-radius: var(--radius-sm); border-left: 3px solid var(--primary-blue);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <strong style="color: var(--primary-blue);">${log.action}</strong>
                                        <span style="font-size: 0.875rem; color: var(--text-tertiary);">${formatDate(log.timestamp)}</span>
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                        <div>By: <strong>${log.byAdmin}</strong></div>
                                        ${log.previousStatus ? `<div>Status: ${log.previousStatus} ‚Üí ${log.newStatus}</div>` : ''}
                                        ${log.reason ? `<div>Reason: <strong>${log.reason}</strong></div>` : ''}
                                        ${log.comment ? `<div>Comment: "${log.comment}"</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Update Form -->
                <div style="padding: 1.5rem; background: var(--bg-secondary); border-radius: var(--radius-md);">
                    <h4 style="margin-bottom: 1rem;">üîß Update Complaint</h4>
                    
                    <div class="form-group">
                        <label class="form-label">Update Status</label>
                        <select id="update-status" class="form-select">
                            <option value="">-- Select Action --</option>
                            ${currentComplaint.status === 'Pending Verification' ? `
                                <option value="Verified">Verify Complaint</option>
                                <option value="Rejected">Reject Complaint</option>
                            ` : ''}
                            ${currentComplaint.status === 'Verified' ? `
                                <option value="In Progress">Mark In Progress</option>
                            ` : ''}
                            ${currentComplaint.status === 'In Progress' ? `
                                <option value="Resolved">Mark Resolved</option>
                            ` : ''}
                        </select>
                    </div>

                    ${currentComplaint.status === 'Pending Verification' || !currentComplaint.department ? `
                        <div class="form-group">
                            <label class="form-label">Assign Department</label>
                            <select id="update-department" class="form-select">
                                <option value="">Select Department</option>
                                <option value="MCD">MCD - Municipal Corporation</option>
                                <option value="PWD">PWD - Public Works Department</option>
                                <option value="DJB">DJB - Delhi Jal Board</option>
                            </select>
                        </div>
                    ` : ''}

                    <div class="form-group">
                        <label class="form-label">Officer Comment</label>
                        <textarea id="update-comment" class="form-textarea" rows="3" placeholder="Add comment or update for citizen...">${currentComplaint.officerComment || ''}</textarea>
                    </div>

                    ${!currentComplaint.eta ? `
                        <div class="form-group">
                            <label class="form-label">Expected Resolution Date</label>
                            <input type="date" id="update-eta" class="form-input" min="${new Date().toISOString().split('T')[0]}">
                        </div>
                    ` : `
                        <div class="form-group">
                            <label class="form-label">Current ETA</label>
                            <input type="text" class="form-input" value="${currentComplaint.eta}" readonly>
                        </div>
                    `}
                </div>
            `;
            
            // Add escalate button if eligible
            const canEscalateFlag = canEscalate(currentComplaint);
            
            modalFooter.innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                ${canEscalateFlag && !currentComplaint.escalated ? 
                    `<button class="btn btn-danger" onclick="escalateCurrentComplaint()" style="background: #dc2626;">‚ö†Ô∏è Escalate</button>` 
                    : ''}
                <button class="btn btn-primary" onclick="updateComplaintData()">üíæ Save Updates</button>
            `;
            
            document.getElementById('modal-title').textContent = currentComplaint.id;
            document.getElementById('detail-modal').classList.add('active');
        }

        function updateComplaintData() {
            const status = document.getElementById('update-status').value;
            const comment = document.getElementById('update-comment').value;
            const departmentEl = document.getElementById('update-department');
            const etaEl = document.getElementById('update-eta');
            
            const department = departmentEl ? departmentEl.value : null;
            const eta = etaEl ? etaEl.value : null;
            
            if (!status && !comment && !department && !eta) {
                showToast('Please make at least one update', 'error');
                return;
            }

            // Check if trying to reject - show rejection modal
            if (status === 'Rejected') {
                openRejectionModal();
                return;
            }
            
            console.log("Updating complaint:", currentComplaint.id, {status, comment, eta, department});
            
            let updated = currentComplaint;
            
            if (status) {
                updated = updateComplaintStatus(
                    currentComplaint.id,
                    status,
                    comment,
                    eta,
                    department
                );
                console.log("Status update result:", updated ? "Success" : "Failed");
            } else {
                // Update only comment/eta/department without status change
                updated = updateComplaint(currentComplaint.id, {
                    officerComment: comment || currentComplaint.officerComment || "",
                    eta: eta || currentComplaint.eta || "",
                    department: department || currentComplaint.department || "",
                    updatedAt: new Date().toISOString()
                });
                console.log("Comment/ETA/Department update result:", updated ? "Success" : "Failed");
            }
            
            if (updated) {
                showToast('Complaint updated successfully', 'success');
                simulateNotification(updated, 'status_update');
                closeModal();
                
                // Re-verify the data was saved
                const savedComplaint = getComplaint(currentComplaint.id);
                console.log("Verification - Complaint after save:", savedComplaint);
                
                loadComplaints();
            } else {
                showToast('Failed to update complaint', 'error');
                console.error('Update failed for complaint:', currentComplaint.id);
            }
        }

        // Rejection Modal Functions
        function openRejectionModal() {
            document.getElementById('rejection-modal').classList.add('active');
            
            // Setup listeners
            const reasonSelect = document.getElementById('rejection-reason');
            const otherContainer = document.getElementById('other-reason-container');
            const commentArea = document.getElementById('rejection-comment');
            const confirmBtn = document.getElementById('confirm-reject-btn');
            
            reasonSelect.onchange = function() {
                if (this.value === 'Other') {
                    otherContainer.style.display = 'block';
                } else {
                    otherContainer.style.display = 'none';
                }
                validateRejectionForm();
            };
            
            commentArea.oninput = function() {
                const charCount = document.getElementById('char-count');
                charCount.textContent = `${this.value.length} / 30 characters`;
                charCount.style.color = this.value.length >= 30 ? 'var(--success-green)' : 'var(--text-tertiary)';
                validateRejectionForm();
            };
            
            document.getElementById('other-reason-text').oninput = validateRejectionForm;
        }

        function closeRejectionModal() {
            document.getElementById('rejection-modal').classList.remove('active');
            // Reset form
            document.getElementById('rejection-reason').value = '';
            document.getElementById('other-reason-text').value = '';
            document.getElementById('rejection-comment').value = '';
            document.getElementById('other-reason-container').style.display = 'none';
            document.getElementById('char-count').textContent = '0 / 30 characters';
        }

        function validateRejectionForm() {
            const reason = document.getElementById('rejection-reason').value;
            const otherReason = document.getElementById('other-reason-text').value;
            const comment = document.getElementById('rejection-comment').value;
            const confirmBtn = document.getElementById('confirm-reject-btn');
            
            let valid = true;
            
            if (!reason) valid = false;
            if (reason === 'Other' && !otherReason.trim()) valid = false;
            if (comment.length < 30) valid = false;
            
            confirmBtn.disabled = !valid;
            
            return valid;
        }

        function confirmRejection() {
            if (!validateRejectionForm()) {
                showToast('Cannot reject without valid reason and comment (min 30 characters)', 'error');
                return;
            }
            
            const reason = document.getElementById('rejection-reason').value;
            const otherReason = document.getElementById('other-reason-text').value;
            const comment = document.getElementById('rejection-comment').value;
            
            const finalReason = reason === 'Other' ? otherReason : reason;
            
            console.log("Confirming rejection:", currentComplaint.id, {reason: finalReason, comment});
            
            const departmentEl = document.getElementById('update-department');
            const etaEl = document.getElementById('update-eta');
            const department = departmentEl ? departmentEl.value : null;
            const eta = etaEl ? etaEl.value : null;
            
            const updated = updateComplaintStatus(
                currentComplaint.id,
                'Rejected',
                comment,
                eta,
                department,
                finalReason
            );
            
            if (updated) {
                showToast('Complaint rejected with reason', 'success');
                simulateNotification(updated, 'status_update');
                closeRejectionModal();
                closeModal();
                loadComplaints();
            } else {
                showToast('Failed to reject complaint', 'error');
            }
        }

        function escalateCurrentComplaint() {
            if (!currentComplaint) return;
            
            console.log("Escalating complaint:", currentComplaint.id);
            
            const complaints = getComplaints();
            const idx = complaints.findIndex(c => c.id === currentComplaint.id);
            
            if (idx === -1) {
                showToast('Complaint not found', 'error');
                return;
            }
            
            // Update complaint with escalation
            complaints[idx].escalated = true;
            complaints[idx].updatedAt = new Date().toISOString();
            complaints[idx].timeline = complaints[idx].timeline || [];
            complaints[idx].timeline.push({ 
                step: "Escalated to Higher Authority", 
                status: "completed",
                date: new Date().toISOString() 
            });
            
            // Save to localStorage
            localStorage.setItem("delhiComplaints", JSON.stringify(complaints));
            console.log("Complaint escalated and saved to delhiComplaints");
            
            showToast('Complaint escalated successfully', 'success');
            simulateNotification(complaints[idx], 'escalated');
            
            closeModal();
            loadComplaints();
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.remove('active');
            currentComplaint = null;
        }

        function initializeRoleBasedNavigation(activePage) {
            const session = SessionManager.getSession();
            const navbar = document.getElementById('main-navbar');
            
            if (!session) {
                window.location.href = 'portal.html';
                return;
            }

            if (session.role === 'admin') {
                navbar.innerHTML = `
                    <div class="container">
                        <div class="nav-brand">
                            <span class="nav-logo">üíß</span>
                            <h2>Delhi Water-Logging System - Admin</h2>
                        </div>
                        <div class="nav-content">
                            <div class="nav-links">
                                <a href="admin-home.html">Admin Home</a>
                                <a href="map.html">üó∫Ô∏è Flood Map</a>
                                <a href="complaint.html">üìù Register Complaint</a>
                                <a href="track.html">üîç Track Complaint</a>
                                <a href="my-complaints.html">üìã All Complaints</a>
                                <a href="admin-complaints.html" class="${activePage === 'admin-complaints' ? 'active' : ''}">‚ö° Manage Complaints</a>
                                <a href="authority.html">üèõÔ∏è Authority Dashboard</a>
                            </div>
                            <div class="nav-controls">
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius-full); border: 1px solid var(--border-color);">
                                    <span style="font-size: 1rem;">üèõÔ∏è</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary);">${session.username || 'Admin'}</span>
                                </div>
                                <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">
                                    <span class="icon" id="theme-icon">üåô</span>
                                    <span id="theme-text">Dark</span>
                                </button>
                                <button class="btn btn-danger" onclick="logout()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    üö™ Logout
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Citizens should not access this page - redirect
                window.location.href = 'citizen-home.html';
            }
        }
    </script>
</body>
</html>